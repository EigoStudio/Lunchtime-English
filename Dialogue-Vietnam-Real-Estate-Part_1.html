<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Part 1: Talking to the Real Estate Agent</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root { --bg: #fdfaf8; --client: #fce4ec; --agent: #ffffff; --accent: #5d4037; --highlight: #a0522d; }
  body { font-family: 'Noto Sans JP', sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; }
  .container { width: 100%; max-width: 650px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid #d7ccc8; }
  
  .header-area { text-align: center; border-bottom: 2px solid #efebe9; margin-bottom: 20px; padding-bottom: 10px; position: relative; }
  h1 { font-size: 1.4rem; color: var(--accent); margin: 0; }
  .settings { position: absolute; right: 0; top: 0; display: flex; align-items: center; gap: 8px; font-size: 0.8rem; color: var(--accent); }
  
  .switch { position: relative; display: inline-block; width: 34px; height: 18px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
  .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
  input:checked + .slider { background-color: var(--highlight); }
  input:checked + .slider:before { transform: translateX(16px); }

  .chat-box { min-height: 500px; overflow-y: auto; border: 1px solid #d7ccc8; padding: 20px; display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; background: #fffaf0; border-radius: 10px; }
  .bubble { max-width: 85%; padding: 15px; border-radius: 12px; line-height: 1.6; font-size: 0.95rem; border: 1px solid #e0e0e0; }
  .agent { align-self: flex-start; background: var(--agent); border-bottom-left-radius: 2px; }
  .client { align-self: flex-end; background: var(--client); border-color: #f8bbd0; border-bottom-right-radius: 2px; }
  .role-name { font-size: 0.75rem; font-weight: bold; color: #795548; margin-bottom: 5px; display: block; }
  .jp { font-size: 0.8rem; color: #8d6e63; display: block; margin-top: 8px; border-top: 1px dashed #d7ccc8; padding-top: 5px; }
  .blank { display: inline-block; border-bottom: 2px solid #5d4037; min-width: 80px; height: 1.2em; vertical-align: middle; margin: 0 4px; background: #f0f0f0; }
  
  .btn { width: 100%; padding: 18px; border: none; background: var(--accent); color: white; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 1.1rem; }
  strong.ans { color: #c2185b; border-bottom: 2px solid #c2185b; font-weight: bold; background: transparent; }
  .progress-text { text-align: center; font-size: 0.8rem; color: #9e9e9e; margin-bottom: 5px; }

  @media print {
    @page { margin: 1.5cm; }
    body { background: white; padding: 0; display: block; color: black; }
    .container { border: none; box-shadow: none; max-width: 100%; padding: 0; }
    .header-area { border-bottom: 1px solid black; }
    .settings, .progress-text, .btn, .jp { display: none !important; }
    .chat-box { border: none; background: white; overflow: visible; display: block; min-height: auto; padding: 0; }
    .bubble { max-width: 100%; width: 100%; background: white !important; border: none; border-bottom: 1px solid #eee; padding: 10px 0; border-radius: 0; page-break-inside: avoid; }
    .role-name { color: black; text-decoration: underline; font-size: 0.85rem; }
    .blank { background: transparent; border-bottom: 1px solid black; min-width: 100px; }
    .ans { display: none !important; }
    h1:after { content: " - Student Worksheet"; font-size: 1rem; }
  }
</style>
</head>
<body>

<div class="container">
  <div class="header-area">
    <h1>Part 1: Talking to the Real Estate Agent</h1>
    <div class="settings">
      <span>Audio</span>
      <label class="switch">
        <input type="checkbox" id="audioToggle" checked>
        <span class="slider"></span>
      </label>
    </div>
  </div>
  
  <div class="progress-text" id="progressText">Step 1 / 13</div>
  <div id="chatBox" class="chat-box"></div>
  
  <div class="controls">
    <button class="btn" id="actionBtn" onclick="handleAction()">Start Dialogue</button>
  </div>
</div>

<script>
const scriptSteps = [
  { role: "Agent", en: "Good morning! So, this is the 2-bedroom unit I mentioned. It is <span class='blank'></span> <span class='blank'></span> and ready to move in.", ans: ["fully", "furnished"], jp: "おはようございます！さて、こちらが以前お話しした2ベッドルームのユニットです。フル家具付きで、すぐに入居可能です。" },
  { role: "Client", en: "Let me see... It’s <span class='blank'></span> <span class='blank'></span> and <span class='blank'></span>. My daughter really likes the <span class='blank'></span> from the balcony.", ans: ["very", "bright", "sunny", "view"], jp: "ええと、そうですね…とても明るくて日当たりがいいですね。娘はバルコニーからの景色をとても気に入っています。" },
  { role: "Agent", en: "I’m glad she likes it. There is a <span class='blank'></span> and a swimming pool on the 5th floor, and we have 24-hour <span class='blank'></span> at the entrance.", ans: ["playground", "security"], jp: "気に入ってくれて嬉しいです。5階には遊び場とプールがありますし、入り口には24時間警備がついています。" },
  { role: "Client", en: "That’s reassuring for a single mother. By the way, I work as a <span class='blank'></span> <span class='blank'></span>. Can I use this small room as a <span class='blank'></span> <span class='blank'></span>?", ans: ["beauty", "consultant", "home", "office"], jp: "シングルマザーの私にとって、それはとても安心です。ところで、私は美容コンサルタントをしています。この小さな部屋をホームオフィスとして使えますか？" },
  { role: "Agent", en: "Certainly. Many <span class='blank'></span> use the second bedroom for work.", ans: ["residents"], jp: "もちろんです。多くの居住者の方が2つ目の寝室を仕事用に使われていますよ。" },
  { role: "Client", en: "Great. Is the <span class='blank'></span> <span class='blank'></span> <span class='blank'></span>? I often have online consultations.", ans: ["internet", "speed", "stable"], jp: "よかった。ネット速度は安定していますか？よくオンラインで相談を受けるので。" },
  { role: "Agent", en: "Yes, it’s high-speed. Also, this building has a <span class='blank'></span> <span class='blank'></span> in case of a power <span class='blank'></span>.", ans: ["backup", "generator", "outage"], jp: "はい、高速ですよ。それに、この建物には停電に備えて自家発電機が備わっています。" },
  { role: "Client", en: "That’s perfect. Now about the <span class='blank'></span>, is the <span class='blank'></span> <span class='blank'></span> included in the <span class='blank'></span>?", ans: ["contract", "management", "fee", "rent"], jp: "完璧ですね。さて契約についてですが、管理費は家賃に含まれていますか？" },
  { role: "Agent", en: "Yes, it is. But the <span class='blank'></span> <span class='blank'></span> like electricity and water are paid <span class='blank'></span>.", ans: ["utility", "bills", "separately"], jp: "はい、含まれています。でも電気や水道のような光熱費は別払いです。" },
  { role: "Client", en: "I see. One more important thing: I need a Red Invoice for the <span class='blank'></span> to claim it as a business <span class='blank'></span>.", ans: ["rent", "expense"], jp: "なるほど。もう一つ重要なことが。仕事の経費として落としたいので、家賃のレッドインボイス（公式領収書）が必要です。" },
  { role: "Agent", en: "I will check with the owner about that. It depends on the unit.", ans: [], jp: "それについてはオーナーに確認しますね。ユニットによって（出せるかどうかが）異なりますので。" },
  { role: "Client", en: "Well, if I decide to sign the <span class='blank'></span> <span class='blank'></span>, how much is the <span class='blank'></span> <span class='blank'></span>?", ans: ["lease", "agreement", "security", "deposit"], jp: "ええと、もし賃貸借契約を結ぶことに決めた場合、敷金はおいくらですか？" },
  { role: "Agent", en: "It is usually equivalent to two months' rent.", ans: [], jp: "通常は家賃2ヶ月分に相当します。" }
];

let sIdx = 0, waiting = false;

function speak(htmlContent) {
  if (!document.getElementById('audioToggle').checked) return;
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = htmlContent;
  const text = tempDiv.textContent || tempDiv.innerText || "";
  const uttr = new SpeechSynthesisUtterance(text);
  uttr.lang = "en-US";
  uttr.rate = 0.9;
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(uttr);
}

function handleAction() {
  const btn = document.getElementById('actionBtn');
  if (sIdx >= scriptSteps.length) {
    location.reload();
    return;
  }

  const step = scriptSteps[sIdx];
  if (!waiting) {
    addBubble(step.role, step.en, step.jp);
    if(step.ans.length > 0) {
      btn.textContent = "Check Answers";
      waiting = true;
    } else {
      speak(step.en); // 穴埋めがない場合は即読み上げ
      sIdx++;
      btn.textContent = (sIdx >= scriptSteps.length) ? "Finish & Restart" : "Next Line";
    }
  } else {
    const bubbles = document.querySelectorAll('.bubble');
    const lastEn = bubbles[bubbles.length - 1].querySelector('.en');
    let newEn = step.en;
    
    step.ans.forEach(a => {
        newEn = newEn.replace("<span class='blank'></span>", `<strong class="ans">${a}</strong>`);
    });

    lastEn.innerHTML = newEn;
    speak(newEn); // 答えが埋まってから読み上げ
    waiting = false; 
    sIdx++;
    document.getElementById('progressText').textContent = `Step ${sIdx} / ${scriptSteps.length}`;
    
    if (sIdx >= scriptSteps.length) {
      btn.textContent = "Finish & Restart";
    } else {
      btn.textContent = "Next Line";
    }
  }
}

function addBubble(role, en, jp) {
  const box = document.getElementById('chatBox');
  const div = document.createElement('div');
  const isAgent = role.toLowerCase() === 'agent';
  div.className = `bubble ${isAgent ? 'agent' : 'client'}`;
  div.innerHTML = `<span class="role-name">${role}</span><span class="en">${en}</span><span class="jp">${jp}</span>`;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

window.onbeforeprint = function() {
    const box = document.getElementById('chatBox');
    box.innerHTML = "";
    scriptSteps.forEach(step => {
        const div = document.createElement('div');
        const isAgent = step.role.toLowerCase() === 'agent';
        div.className = `bubble ${isAgent ? 'agent' : 'client'}`;
        div.innerHTML = `<span class="role-name">${step.role}</span><span class="en">${step.en}</span><span class="jp">${step.jp}</span>`;
        box.appendChild(div);
    });
};
</script>
</body>
</html>