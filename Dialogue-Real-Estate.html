<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Real Estate Dialogue: Finding an Apartment</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root { --bg: #fdfaf8; --client: #e3f2fd; --agent: #ffffff; --accent: #5d4037; --highlight: #a0522d; }
  body { font-family: 'Noto Sans JP', sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; }
  .container { width: 100%; max-width: 650px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid #d7ccc8; }
  
  .header-area { text-align: center; border-bottom: 2px solid #efebe9; margin-bottom: 20px; padding-bottom: 10px; position: relative; }
  h1 { font-size: 1.4rem; color: var(--accent); margin: 0; }
  .settings { position: absolute; right: 0; top: 0; display: flex; align-items: center; gap: 8px; font-size: 0.8rem; color: var(--accent); }
  
  .switch { position: relative; display: inline-block; width: 34px; height: 18px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
  .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
  input:checked + .slider { background-color: var(--highlight); }
  input:checked + .slider:before { transform: translateX(16px); }

  .chat-box { min-height: 500px; overflow-y: auto; border: 1px solid #d7ccc8; padding: 20px; display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; background: #fffaf0; border-radius: 10px; }
  .bubble { max-width: 85%; padding: 15px; border-radius: 12px; line-height: 1.6; font-size: 0.95rem; border: 1px solid #e0e0e0; }
  .agent { align-self: flex-start; background: var(--agent); border-bottom-left-radius: 2px; }
  .client { align-self: flex-end; background: var(--client); border-color: #bbdefb; border-bottom-right-radius: 2px; }
  .role-name { font-size: 0.75rem; font-weight: bold; color: #795548; margin-bottom: 5px; display: block; }
  .jp { font-size: 0.8rem; color: #8d6e63; display: block; margin-top: 8px; border-top: 1px dashed #d7ccc8; padding-top: 5px; }
  .blank { display: inline-block; border-bottom: 2px solid #5d4037; min-width: 80px; height: 1.2em; vertical-align: middle; margin: 0 4px; background: #f0f0f0; }
  
  .btn { width: 100%; padding: 18px; border: none; background: var(--accent); color: white; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 1.1rem; }
  strong.ans { color: #1565c0; border-bottom: 2px solid #1565c0; font-weight: bold; background: transparent; }
  .progress-text { text-align: center; font-size: 0.8rem; color: #9e9e9e; margin-bottom: 5px; }

  @media print {
    @page { margin: 1.5cm; }
    body { background: white; padding: 0; display: block; color: black; }
    .container { border: none; box-shadow: none; max-width: 100%; padding: 0; }
    .header-area { border-bottom: 1px solid black; }
    .settings, .progress-text, .btn, .jp { display: none !important; }
    .chat-box { border: none; background: white; overflow: visible; display: block; min-height: auto; padding: 0; }
    .bubble { max-width: 100%; width: 100%; background: white !important; border: none; border-bottom: 1px solid #eee; padding: 10px 0; border-radius: 0; page-break-inside: avoid; }
    .role-name { color: black; text-decoration: underline; font-size: 0.85rem; }
    .blank { background: transparent; border-bottom: 1px solid black; min-width: 100px; }
    .ans { display: none !important; }
    h1:after { content: " - Student Worksheet"; font-size: 1rem; }
  }
</style>
</head>
<body>

<div class="container">
  <div class="header-area">
    <h1>At the Real Estate Office</h1>
    <div class="settings">
      <span>Audio</span>
      <label class="switch">
        <input type="checkbox" id="audioToggle" checked>
        <span class="slider"></span>
      </label>
    </div>
  </div>
  
  <div class="progress-text" id="progressText">Step 1 / 10</div>
  <div id="chatBox" class="chat-box"></div>
  
  <div class="controls">
    <button class="btn" id="actionBtn" onclick="handleAction()">Start Dialogue</button>
  </div>
</div>

<script>
const scriptSteps = [
  { role: "Agent", en: "Good afternoon. Welcome to our <span class='blank'></span> <span class='blank'></span>. How can I help you today?", ans: ["real", "estate"], jp: "こんにちは。不動産会社へようこそ。本日はどのようなご用件でしょうか。" },
  { role: "Customer", en: "Good afternoon. I'm looking for an <span class='blank'></span> to <span class='blank'></span> near downtown.", ans: ["apartment", "rent"], jp: "こんにちは。市内中心部の近くで借りられるアパートを探しています。" },
  { role: "Agent", en: "Of course. May I ask your <span class='blank'></span> <span class='blank'></span>?", ans: ["budget", "range"], jp: "かしこまりました。ご予算はどのくらいでしょうか。" },
  { role: "Customer", en: "Around 8,000,000 to 10,000,000 VND per month.", ans: [], jp: "月額800万~1000万VNDくらいです。" },
  { role: "Agent", en: "I see. Do you have any preferences in terms of size or <span class='blank'></span> from the <span class='blank'></span>?", ans: ["distance", "station"], jp: "承知しました。広さや駅からの距離など、ご希望はありますか。" },
  { role: "Customer", en: "Yes, I prefer at least <span class='blank'></span> and within 10-20 minutes <span class='blank'></span> distance from a station.", ans: ["1LDK", "walking"], jp: "はい。少なくとも1LDKで、駅から徒歩10-20分以内がいいです。" },
  { role: "Agent", en: "Understood. Do you need <span class='blank'></span>?", ans: ["parking"], jp: "参考になります。駐車場は必要ですか。" },
  { role: "Customer", en: "No, I don't have a car. I'm planning to <span class='blank'></span> <span class='blank'></span> in June if possible.", ans: ["move", "in"], jp: "いいえ、車は持っていません。できれば6月頃に入居したいです。" },
  { role: "Agent", en: "We have a few properties. Would you like to see photos first or <span class='blank'></span> them in <span class='blank'></span>?", ans: ["visit", "person"], jp: "条件に合う物件がいくつかございます。まず写真をご覧になりますか、それとも実際に内見されますか。" },
  { role: "Customer", en: "I'd like to <span class='blank'></span> in person. That sounds good. Thank you.", ans: ["visit"], jp: "実際に内見したいです。いいですね、ありがとうございます。" }
];

let sIdx = 0, waiting = false;

function speak(htmlContent) {
  if (!document.getElementById('audioToggle').checked) return;
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = htmlContent;
  const text = tempDiv.textContent || tempDiv.innerText || "";
  const uttr = new SpeechSynthesisUtterance(text);
  uttr.lang = "en-US";
  uttr.rate = 0.9;
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(uttr);
}

function handleAction() {
  const btn = document.getElementById('actionBtn');
  if (sIdx >= scriptSteps.length) {
    location.reload();
    return;
  }

  const step = scriptSteps[sIdx];
  if (!waiting) {
    addBubble(step.role, step.en, step.jp);
    if(step.ans.length > 0) {
      btn.textContent = "Check Answers";
      waiting = true;
    } else {
      speak(step.en);
      sIdx++;
      btn.textContent = (sIdx >= scriptSteps.length) ? "Finish & Restart" : "Next Line";
    }
  } else {
    const bubbles = document.querySelectorAll('.bubble');
    const lastEn = bubbles[bubbles.length - 1].querySelector('.en');
    let newEn = step.en;
    
    step.ans.forEach(a => {
        newEn = newEn.replace("<span class='blank'></span>", `<strong class="ans">${a}</strong>`);
    });

    lastEn.innerHTML = newEn;
    speak(newEn);
    waiting = false; 
    sIdx++;
    document.getElementById('progressText').textContent = `Step ${sIdx} / ${scriptSteps.length}`;
    
    if (sIdx >= scriptSteps.length) {
      btn.textContent = "Finish & Restart";
    } else {
      btn.textContent = "Next Line";
    }
  }
}

function addBubble(role, en, jp) {
  const box = document.getElementById('chatBox');
  const div = document.createElement('div');
  const isAgent = role.toLowerCase() === 'agent';
  div.className = `bubble ${isAgent ? 'agent' : 'customer'}`;
  div.innerHTML = `<span class="role-name">${role}</span><span class="en">${en}</span><span class="jp">${jp}</span>`;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

window.onbeforeprint = function() {
    const box = document.getElementById('chatBox');
    box.innerHTML = "";
    scriptSteps.forEach(step => {
        const div = document.createElement('div');
        const isAgent = step.role.toLowerCase() === 'agent';
        div.className = `bubble ${isAgent ? 'agent' : 'customer'}`;
        div.innerHTML = `<span class="role-name">${step.role}</span><span class="en">${step.en}</span><span class="jp">${step.jp}</span>`;
        box.appendChild(div);
    });
};
</script>
</body>
</html>